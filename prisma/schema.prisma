generator client {
  provider = "prisma-client-js"
   output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"

}

// --------------------
// ENUMS
// --------------------

enum AdminRole {
  tournamentManager
  superAdmin
}
enum TournamentStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum MatchStatus {
  SCHEDULED
  LIVE
  FINISHED
  POSTPONED
}

enum NotificationType {
  BROADCAST          // platform-wide
  TOURNAMENT_UPDATE  // tournament-related
  DIRECT_MESSAGE     // admin â†’ admin
  SYSTEM             // AI / system generated
}


enum GoalType {
  normal
  penalty
  ownGoal
}

enum EventType {
  Goal
  Yellow
  Red
}

enum MediaOwnerType {
  TOURNAMENT
  MATCH
  TEAM
  PLAYER
  WEB
}

enum ImageUsage {
  COVER      // tournament cover, match poster
  GALLERY    // multiple images
  AVATAR     // player profile
  LOGO       // team logo
  BANNER     // header images
}


// --------------------
// MODELS
// --------------------

// ADMIN
model Admin {
  id        String @id @default(uuid())
  email     String @unique
  username  String @unique
  fullName  String
  password  String
  refreshToken String?
  role      AdminRole @default(tournamentManager)
  isActive  Boolean   @default(true)

  tournaments           Tournament[]  @relation("ManagedTournaments")
  sentNotifications     Notification[] @relation("Sender")
  receivedNotifications Notification[] @relation("Receiver")
}



// PLAYER
model Player {
  id        String     @id @default(uuid())
  name      String
  position  String
  number    Int        @default(99)
  teamId    String

  // Relations
  playerMatchStats PlayerMatchStats[]
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  events    MatchEvent[]
  goalScore GoalScorer[]

  @@unique([teamId, number])
  @@index([teamId])
}


// TEAM
model Team {
  id         String     @id @default(uuid())
  teamName   String     @unique
  coachName   String?
  coachEmail  String?
  power Int @default(0)
  registrationKey String? @unique
  accessKey String?       @unique
  expiredRegistration DateTime?
//relation
  players      Player[]
  matchEvent   MatchEvent[]
  homeMatches  Match[]    @relation("HomeTeam")
  awayMatches  Match[]    @relation("AwayTeam")
  standings     TournamentStanding[] 
  tournaments  TournamentTeam[]
}


// TOURNAMENT
model Tournament {
  id             String     @id @default(uuid())
  managerId      String?
  tournamentName String
  startingDate   DateTime
  endingDate     DateTime 
  description    String
  venue          String?
  sponsor        String?
  status         TournamentStatus
//relation
  notification    Notification[]
  manager        Admin?       @relation("ManagedTournaments", fields: [managerId], references: [id], onDelete: Cascade)
  teams          TournamentTeam[]
  matches        Match[]
  standings      TournamentStanding[]   
  
  @@index([status])
}

// TOURNAMENT TEAM (JUNCTION TABLE)
model TournamentTeam {
  id           String    @id @default(uuid())
  tournamentId String
  teamId       String

  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, teamId])
  @@index([tournamentId])
  @@index([teamId]) // prevent duplicate registrations
}

model PlayerMatchStats {
  id        String @id @default(uuid())
  playerId  String
  matchId   String

  goals     Int @default(0)
  assists   Int @default(0)
  yellow    Int @default(0)
  red       Int @default(0)
  minutes   Int @default(0)

  player    Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  match     Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@unique([playerId, matchId])
  @@index([matchId])
  @@index([playerId])
}



// MATCH
model Match {
  id            String       @id @default(uuid())
  tournamentId  String
  scheduledDate DateTime
  homeTeamId    String
  awayTeamId    String
  venue         String
  referee       String?
  status        MatchStatus
  homeScore     Int @default(0)
  awayScore     Int @default(0)
  matchWeek Int?


  // Relations
  playerMatchStats PlayerMatchStats[]
  tournament    Tournament   @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  homeTeam      Team         @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeam      Team         @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  events        MatchEvent[]
  goalScore     GoalScorer[]

  matchStats    MatchStats?
  @@unique([homeTeamId, awayTeamId, scheduledDate])

  @@index([tournamentId])
  @@index([status])
  @@index([scheduledDate])
}

// MATCH EVENTS
model MatchEvent {
  id          String     @id @default(ulid())
  matchId     String
  playerId    String
  eventTeamId String
  minute      Int
  eventType   EventType
  processingStatus  String

//relation
  match       Match      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player      Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team        Team       @relation(fields: [eventTeamId],references: [id], onDelete: Cascade)

}


// GOAL SCORERS
model GoalScorer {
  id        String     @id @default(uuid())
  playerId  String
  matchId   String
  goaltype  GoalType    @default(normal)
  minute    Int

  match     Match       @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player    Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId,matchId])
}


// MATCH STATS (Required for AI & Predictions)
model MatchStats {
  id             String   @id @default(uuid())
  matchId        String   @unique
  possessionHome Float?
  possessionAway Float?
  shotsHome      Int?
  shotsAway      Int?
  shotsOnTargetHome Int?
  shotsOnTargetAway Int?
  foulsHome      Int?
  foulsAway      Int?
  cornersHome    Int?
  cornersAway    Int?

  match          Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId])
}


// MEDIA
model MediaGallery {
  id            String         @id @default(uuid())

  url           String
  publicId      String?        // Cloudinary / S3 key

  ownerType     MediaOwnerType
  ownerId       String

  usage         ImageUsage

  width         Int?
  height        Int?
  size          Int?           // bytes
  format        String?        // png, jpg, webp

  isPrimary     Boolean        @default(false)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

   @@index([ownerType, ownerId])
  @@index([usage])
}



// NOTIFICATIONS
model Notification {
  id               String            @id @default(uuid())

  type             NotificationType

  message          String?

  // Scope
  tournamentId     String?           // null = platform-wide
  receiverAdminId  String?         // null = broadcast
  senderAdminId    String?           // null = system / AI

  // State
  isRead           Boolean           @default(false)
  readAt           DateTime?
  meta             Json?
  // Metadata
  createdAt        DateTime          @default(now())

  // Relations
  tournament       Tournament?       @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  sender           Admin?             @relation("Sender", fields: [senderAdminId], references: [id], onDelete: Cascade)
  receiver         Admin?             @relation("Receiver", fields: [receiverAdminId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([tournamentId])
  @@index([receiverAdminId])
}

model TournamentStanding {
  id             String     @id @default(uuid())
  tournamentId   String
  teamId         String

  // Standings Metrics
  played         Int        @default(0)
  wins           Int        @default(0)
  draws          Int        @default(0)
  losses         Int        @default(0)
  goalsFor       Int        @default(0)
  goalsAgainst   Int        @default(0)
  goalDifference Int        @default(0)
  points         Int        @default(0)
  rank           Int?
  form           String? 
  // Relations
  tournament     Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team           Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, teamId]) // A team can't have 2 records in same tournament

  @@index([tournamentId])
}